%% Read data
OptionDataFull = csvread("spOptions_Bloomberg_SeparateDate.csv", 1, 0);

yearIdx = 3;
monthIdx = 4;
dayIdx = 5;

OptionDataIdx = find(OptionDataFull(:,yearIdx) == 2018 & ...
                     OptionDataFull(:,monthIdx) == 4 & ...
                     OptionDataFull(:,dayIdx) == 17);
                        
OptionData = OptionDataFull(OptionDataIdx, :);
% OptionData = csvread("spOptions_Bloomberg_02062018.csv", 1, 0);

%% Add midpoints of strike prices
strike_price = OptionData(:,1);
strike_price_avg = 0.5*(strike_price(1:end-1)+strike_price(2:end));

strike_price_full = [strike_price;strike_price_avg];
strike_price_full = sort(strike_price_full);

IndexList = [1:2:length(strike_price_full)]'; % Indices of real strike prices
%% Initialize
Cvar = zeros(length(strike_price_full), 1);
Cvar(IndexList) = OptionData(:,2);
alpha = 0.000001;
deltaKj = strike_price_full(2:end) - strike_price_full(1:end-1);

%% Interpolation and Smooth
strike_price_full_25 = [min(strike_price):2.5:max(strike_price)]';
IndexList_25 = [];
for i = 1:length(strike_price_full_25)
    findIdx = find(strike_price_full == strike_price_full_25(i));
    if ~isempty(findIdx)
        IndexList_25 = [IndexList_25; i];
    end
end

IndexList_25_R = [];
for i = 1:length(strike_price_full_25)
    findIdx = find(strike_price == strike_price_full_25(i));
    if ~isempty(findIdx)
        IndexList_25_R = [IndexList_25_R; i];
    end
end


[IndexList_25_R(1:10), strike_price(1:10), strike_price_full_25(IndexList_25_R(1:10))]
% [IndexList_25(1:10), strike_price_full(1:10), strike_price_full_25(IndexList_25(1:10))]
% [IndexList_25, strike_price_full, strike_price_full_25(IndexList_25)]

Cvar_25 = zeros(length(strike_price_full_25), 1);
Cvar_25(IndexList_25_R) = OptionData(:,2);

xInit_25 = spline(strike_price_full_25(IndexList_25_R), Cvar_25(IndexList_25_R), strike_price_full_25);
xInit_smooth_25_Func = fit([strike_price_full_25 ones(size(strike_price_full_25, 1), 1)], xInit_25, 'lowess');
xInit_smooth_25 = xInit_smooth_25_Func([strike_price_full_25 ones(size(strike_price_full_25, 1), 1)]);

deltaKj_25 = strike_price_full_25(2:end) - strike_price_full_25(1:end-1);
% Plot_x_derivatives(xInit_smooth_25, xInit_smooth_25, deltaKj_25, strike_price_full_25);

%%% Create A, b for 25
% 
% A1_25 = diag(-ones(length(strike_price_full_25), 1), 0) + ...
%     diag(ones(length(strike_price_full_25) - 1, 1), 1);
% A1_25 = A1_25(1:end-1,:);
% b1_25 = zeros(length(strike_price_full_25)-1, 1);
% 
% A2_25 = diag([deltaKj_25; 0; 0], 0) + ...
%     diag(-[0;deltaKj_25] - [deltaKj_25; 0], 1) + ...
%     diag([0; deltaKj_25(1:end-1)], 2);
% A2_25 = -A2_25(2:end-2,2:end);
% b2_25 = zeros(length(strike_price_full_25)-2, 1);
% 
% A_25 = [A1_25; A2_25];
% b_25 = [b1_25; b2_25];
% 
% %%% Optimization for 25
% options = optimoptions('fmincon','Display','iter','Algorithm','sqp', ...
%     'MaxFunctionEvaluations', 1e8, 'MaxIterations', 1e6,...
%     'StepTolerance', 1e-12, 'FunctionTolerance', 1e-9);
% lossFunc_25 = @(x) LossFunction(x, Cvar_25, IndexList_25_R, alpha, deltaKj_25);
% [x_25, fval, exitflag, output] = fmincon(lossFunc_25, ...
%     xInit_smooth_25, A_25, b_25, [], [], [], [], [], options);
% 
% Plot_x_derivatives(x_25, xInit_smooth_25, deltaKj_25, strike_price_full_25);
% xInit_smooth = x_25(IndexList_25);

xInit_smooth = xInit_smooth_25(IndexList_25);

%% Create A, b
A1 = diag(-ones(length(strike_price_full), 1), 0) + ...
    diag(ones(length(strike_price_full) - 1, 1), 1);
A1 = A1(1:end-1,:);
b1 = zeros(length(strike_price_full)-1, 1);

A2 = diag([deltaKj; 0; 0], 0) + ...
    diag(-[0;deltaKj] - [deltaKj; 0], 1) + ...
    diag([0; deltaKj(1:end-1)], 2);
A2 = -A2(2:end-2,2:end);
b2 = zeros(length(strike_price_full)-2, 1);

A = [A1; A2];
b = [b1; b2];

%% Solve problem
options = optimoptions('fmincon','Display','iter','Algorithm','sqp', ...
    'MaxFunctionEvaluations', 1e8, 'MaxIterations', 1e6,...
    'StepTolerance', 1e-12, 'FunctionTolerance', 1e-9);
lossFunc = @(x) LossFunction(x, Cvar, IndexList, alpha, deltaKj);

[x, fval, exitflag, output] = fmincon(lossFunc, ...
    xInit_smooth, A, b, [], [], [], [], [], options);

x = [1.74378080e03 1.50514836e03 1.32601179e03 1.20376034e03 1.13834550e03 1.13040354e03 1.12152538e03 1.10539165e03 1.08030826e03 1.06419932e03 1.04421013e03 1.02033861e03 9.92316467e02 9.60514544e02 9.32308336e02 9.09205683e02 8.91023593e02 8.70369800e02 8.47115460e02 8.21062723e02 7.93668920e02 7.68066143e02 7.43274958e02 7.18388048e02 6.93361352e02 6.80929508e02 6.68594282e02 6.56356325e02 6.44256225e02 6.32180685e02 6.20288113e02 6.08054695e02 5.95590580e02 5.83240389e02 5.70826697e02 5.58074647e02 5.43567227e02 5.27304364e02 5.10355679e02 5.00952167e02 4.99296715e02 4.97748206e02 4.95148003e02 4.91495945e02 4.86829996e02 4.84367989e02 4.81886603e02 4.79406844e02 4.76928715e02 4.71978465e02 4.67040676e02 4.62112866e02 4.57190947e02 4.52274228e02 4.47365327e02 4.42473615e02 4.37599083e02 4.35150257e02 4.32693129e02 4.30227677e02 4.27755235e02 4.22813846e02 4.17899442e02 4.13012904e02 4.08139471e02 4.03279130e02 3.98431856e02 3.93597759e02 3.88754688e02 3.86325080e02 3.83888373e02 3.81444434e02 3.78994020e02 3.74079581e02 3.69160246e02 3.64258618e02 3.59392706e02 3.54560349e02 3.49761535e02 3.44979094e02 3.40185858e02 3.37782671e02 3.35375768e02 3.32965865e02 3.30554249e02 3.25728712e02 3.20912151e02 3.18504975e02 3.16097064e02 3.13688417e02 3.11278683e02 3.08871508e02 3.06469588e02 3.04072969e02 3.01680826e02 2.99291678e02 2.96903053e02 2.94515690e02 2.92130175e02 2.89746604e02 2.87364984e02 2.84981590e02 2.82594151e02 2.80202664e02 2.77819029e02 2.75445428e02 2.73081838e02 2.70722453e02 2.68356539e02 2.65983686e02 2.63603893e02 2.61233447e02 2.58873579e02 2.56524153e02 2.54184652e02 2.51850073e02 2.49509352e02 2.47162486e02 2.44809870e02 2.42452329e02 2.40097828e02 2.37746549e02 2.35399836e02 2.33061029e02 2.30733096e02 2.28415368e02 2.26102007e02 2.23792756e02 2.21487145e02 2.19183384e02 2.16881473e02 2.14581037e02 2.12280994e02 2.09981344e02 2.07682084e02 2.05384163e02 2.03092103e02 2.00808649e02 1.98533824e02 1.96265318e02 1.94002415e02 1.91744133e02 1.89487103e02 1.87231326e02 1.84980025e02 1.82733161e02 1.80488852e02 1.78246580e02 1.76006600e02 1.73768859e02 1.71533353e02 1.69303507e02 1.67085622e02 1.64879374e02 1.62675105e02 1.60472415e02 1.58271385e02 1.56079879e02 1.53901662e02 1.51737173e02 1.49586112e02 1.47444553e02 1.45306643e02 1.43168063e02 1.41028512e02 1.38889320e02 1.36752146e02 1.34622745e02 1.32504930e02 1.30399185e02 1.28305510e02 1.26220754e02 1.24144880e02 1.22078017e02 1.20020172e02 1.17971436e02 1.15931808e02 1.13901540e02 1.11881091e02 1.09872276e02 1.07875095e02 1.05885770e02 1.03904362e02 1.01931665e02 9.99717018e01 9.80269159e01 9.60973092e01 9.41829594e01 9.22832116e01 9.03908217e01 8.85059870e01 8.66293982e01 8.47647890e01 8.29134282e01 8.10851660e01 7.92800307e01 7.74977678e01 7.57342213e01 7.39847511e01 7.22490515e01 7.05224554e01 6.88038608e01 6.70932651e01 6.53917019e01 6.37044235e01 6.20402557e01 6.04011902e01 5.87872040e01 5.71931252e01 5.56139906e01 5.40526965e01 5.25213437e01 5.10202473e01 4.95468827e01 4.81008872e01 4.66822615e01 4.52772780e01 4.38853432e01 4.25063227e01 4.11402873e01 3.97967281e01 3.84791861e01 3.71933836e01 3.59416027e01 3.47239425e01 3.35404025e01 3.23897388e01 3.12655014e01 3.01553238e01 2.90586200e01 2.79848809e01 2.69415535e01 2.59286334e01 2.49451141e01 2.39907653e01 2.30604878e01 2.21548415e01 2.12745266e01 2.04231192e01 1.95996156e01 1.88033796e01 1.80344157e01 1.72930547e01 1.65792244e01 1.58902000e01 1.52241523e01 1.45798462e01 1.33563778e01 1.22194269e01 1.11689825e01 1.02024502e01 8.90531284e00 7.78758935e00 6.18207067e00 4.89706668e00 3.85289421e00 3.05731960e00 2.50920977e00 2.03077320e00 1.53746147e00 1.36574292e00 1.05887606e00 8.77994216e01 7.14135413e01 4.99900184e01 3.52024195e01 2.62702569e01 2.01228808e01 1.85310742e01]';
x = [1.74167730e3 1.50518433e3 1.32514513e3 1.20158989e3 1.13646803e3 1.12977977e3 1.12008819e3 1.10413482e3 1.07956980e3 1.06403538e3 1.04427176e3 1.02051118e3 9.92183631e2 9.60156809e2 9.31902759e2 9.09219435e2 8.90883142e2 8.70192890e2 8.46997266e2 8.20957412e2 7.93634997e2 7.68012793e2 7.43212297e2 7.18378973e2 6.93374762e2 6.80879195e2 6.68589131e2 6.56377112e2 6.44284358e2 6.32198995e2 6.20289967e2 6.08047433e2 5.95626196e2 5.83304943e2 5.70835787e2 5.57961964e2 5.43437629e2 5.27202326e2 5.10376781e2 5.00961995e2 4.99312191e2 4.97748975e2 4.95140853e2 4.91487568e2 4.86827798e2 4.84367829e2 4.81888330e2 4.79407292e2 4.76927630e2 4.71973758e2 4.67033336e2 4.62106979e2 4.57186706e2 4.52272787e2 4.47363823e2 4.42472427e2 4.37598829e2 4.35149863e2 4.32692733e2 4.30227477e2 4.27754236e2 4.22811273e2 4.17897364e2 4.13012019e2 4.08139170e2 4.03278664e2 3.98430483e2 3.93594670e2 3.88755023e2 3.86325418e2 3.83888477e2 3.81444200e2 3.78992861e2 3.74078095e2 3.69156163e2 3.64255245e2 3.59387568e2 3.54555011e2 3.49758841e2 3.44977363e2 3.40184193e2 3.37782041e2 3.35376209e2 3.32966697e2 3.30553566e2 3.25727067e2 3.20911197e2 3.18504247e2 3.16096483e2 3.13687807e2 3.11278300e2 3.08871726e2 3.06469944e2 3.04073013e2 3.01680761e2 2.99290772e2 2.96902824e2 2.94516436e2 2.92131211e2 2.89747145e2 2.87364165e2 2.84980754e2 2.82593680e2 2.80202943e2 2.77819559e2 2.75445892e2 2.73081942e2 2.70721834e2 2.68355586e2 2.65982491e2 2.63603371e2 2.61233409e2 2.58873444e2 2.56523762e2 2.54184362e2 2.51849255e2 2.49508887e2 2.47162254e2 2.44809908e2 2.42452589e2 2.40098123e2 2.37746636e2 2.35399466e2 2.33060768e2 2.30732434e2 2.28414613e2 2.26101723e2 2.23792492e2 2.21486395e2 2.19183283e2 2.16881690e2 2.14580782e2 2.12280483e2 2.09980795e2 2.07681874e2 2.05383895e2 2.03092545e2 2.00809132e2 1.98533660e2 1.96265225e2 1.94002905e2 1.91743691e2 1.89486204e2 1.87230487e2 1.84979378e2 1.82732570e2 1.80488472e2 1.78246564e2 1.76006646e2 1.73768721e2 1.71533013e2 1.69303346e2 1.67085207e2 1.64878598e2 1.62674696e2 1.60471979e2 1.58271401e2 1.56079991e2 1.53901653e2 1.51737025e2 1.49586106e2 1.47444349e2 1.45306391e2 1.43167977e2 1.41029100e2 1.38889758e2 1.36752795e2 1.34623194e2 1.32505215e2 1.30399141e2 1.28304963e2 1.26219832e2 1.24143995e2 1.22077454e2 1.20019820e2 1.17971204e2 1.15931531e2 1.13901300e2 1.11881049e2 1.09872211e2 1.07874466e2 1.05885353e2 1.03904218e2 1.01931363e2 9.99714953e1 9.80266137e1 9.60972695e1 9.41830386e1 9.22832863e1 9.03909602e1 8.85058707e1 8.66289808e1 8.47641761e1 8.29132024e1 8.10849025e1 7.92795589e1 7.74971604e1 7.57339185e1 7.39847486e1 7.22489269e1 7.05225646e1 6.88038964e1 6.70932231e1 6.53916942e1 6.37052374e1 6.20407419e1 6.04016672e1 5.87872656e1 5.71929234e1 5.56138519e1 5.40525189e1 5.25210603e1 5.10199699e1 4.95464765e1 4.81005788e1 4.66818174e1 4.52771173e1 4.38852340e1 4.25061687e1 4.11407332e1 3.97965955e1 3.84786870e1 3.71930414e1 3.59414290e1 3.47241568e1 3.35405550e1 3.23903477e1 3.12657960e1 3.01550941e1 2.90582474e1 2.79849148e1 2.69419172e1 2.59286961e1 2.49449801e1 2.39903957e1 2.30601009e1 2.21544611e1 2.12737785e1 2.04226776e1 1.95992481e1 1.88032057e1 1.80344754e1 1.72930734e1 1.65790703e1 1.58896044e1 1.52237981e1 1.45795254e1 1.33573681e1 1.22220904e1 1.11714010e1 1.02053681e1 8.90125936e0 7.78032535e0 6.19790136e0 4.89909340e0 3.85503357e0 3.06200351e0 2.52000848e0 2.02778181e0 1.53338509e0 1.36850920e0 1.05852188e0 8.71363575e1 7.16604484e1 4.99918357e1 3.53637792e1 2.62468675e1 2.01413251e1 1.85900268e1]';
length(x)
length(strike_price_full)
length(deltaKj)
%% Plots
% clf
lineWidth = 2;
legend1 = "optimization result";
legend2 = "Lowess result";

figure()
subplot(5, 1, 1)
scatter(strike_price_full, x)
hold on
% plot(strike_price_full, xInit_smooth, 'LineWidth', lineWidth)
legend(legend1, legend2)

subplot(5, 1, 2)
scatter(strike_price_full(1:end-1), CalculateDerivativesWithXandDeltaK(x, deltaKj, 1))
hold on
% plot(strike_price_full(1:end-1), CalculateDerivativesWithXandDeltaK(xInit_smooth, deltaKj, 1), 'LineWidth', lineWidth)
legend(legend1, legend2)

subplot(5, 1, 3)
plot(strike_price_full(1:end-2), CalculateDerivativesWithXandDeltaK(x, deltaKj, 2))
hold on
% plot(strike_price_full(1:end-2), CalculateDerivativesWithXandDeltaK(xInit_smooth, deltaKj, 2), 'LineWidth', lineWidth)
legend(legend1, legend2)

subplot(5, 1, 4)
scatter(strike_price_full(1:end-3), CalculateDerivativesWithXandDeltaK(x, deltaKj, 3))
hold on
% plot(strike_price_full(1:end-3), CalculateDerivativesWithXandDeltaK(xInit_smooth, deltaKj, 3), 'LineWidth', lineWidth)
legend(legend1, legend2)

subplot(5, 1, 5)
scatter(strike_price_full(1:end-4), CalculateDerivativesWithXandDeltaK(x, deltaKj, 4))
hold on
% plot(strike_price_full(1:end-4), CalculateDerivativesWithXandDeltaK(xInit_smooth, deltaKj, 4), 'LineWidth', lineWidth)
legend(legend1, legend2)

h = suptitle('Optimization vs Lowess');
set(h,'FontSize',20,'FontWeight','normal')